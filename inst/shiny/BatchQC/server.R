library(shiny)
library(ggvis)
library(d3heatmap)
library(reshape2)
shinyServer(function(input, output, session) {
  pc <- shinyInput$pc
  cormat <- shinyInput$cormat
  delta.hat <- shinyInput$delta.hat
  gamma.hat <- shinyInput$gamma.hat
  gamma.bar <- shinyInput$gamma.bar
  lcounts <- shinyInput$lcounts
  t2 <- shinyInput$t2
  a.prior <- shinyInput$a.prior
  b.prior <- shinyInput$b.prior
  
  #interactive PCA
  PCA <- reactive({
    data.frame(pc[, c(input$xcol,input$ycol)])
  })
  
  #interactive PCA plot
  vis_pc <- reactive({
      pc$id <- 1:nrow(pc)  
      
      all_values <- function(x) {
        if(is.null(x)) return(NULL)
        row <- pc[pc$id == x$id, ]
        paste0(paste0("PC", input$xcol), ": ", signif(with(row, get(names(row)[input$xcol])),3), "<br>", paste0("PC", input$ycol), ": ", signif(with(row, get(names(row)[input$ycol])),3), "<br>")
      }
    
      pc %>%
        ggvis(~get(names(pc)[input$xcol]), ~get(names(pc)[input$ycol]), fill = ~factor(batch), key := ~id) %>%
        layer_points(size := 75, size.hover := 200) %>%
        add_tooltip(all_values, "hover") %>%
        add_axis("x", title = paste0("PC",input$xcol), properties = axis_props(
          title = list(fontSize = 15),
          labels = list(fontSize = 10)
        )) %>%
        add_axis("y", title = paste0("PC",input$ycol), properties = axis_props(
          title = list(fontSize = 15),
          labels = list(fontSize = 10)
        )) %>%
        add_legend("fill", title = "Batches", properties = legend_props(
          title = list(fontSize = 15),
          labels = list(fontSize = 10)
        )) %>%
        set_options(width = "auto", height = "auto", resizable=TRUE)
  })
  
  #interactive PCA summary
  vis_pc %>% bind_shiny("plot")
  output$PCAsummary <- renderPrint({
    summary(PCA())
  })
  
  #interactive PCA table
  output$PCAtable <- renderTable({
    PCA()
  })

  #interactive boxplot
  BP <- reactive({
    dat <- lcounts
    batch1 <- as.factor(batch)
    batch2 <- split(which(batch == batch1), batch1)
    batch3 <- unlist(lapply(1:length(batch2), function(x) batch2[[x]][1:input$noSamples]))
    dat[,batch3]
  })
  #interactive boxplot
  vis_bp <- reactive({
    batch4 <- split(batch, as.factor(batch))
    batch5 <- unlist(lapply(1:length(batch4), function(x) batch4[[x]][1:input$noSamples]))
    dat1 <- BP()
    colnames(dat1) <- seq(1:ncol(dat1))
    dat2 <- melt(as.data.frame(dat1))
    dat2$Batch <- as.factor(unlist(lapply(1:length(batch5), function(x) rep(batch5[x], nrow(dat1)))))
    colnames(dat2) <- c("Sample","Expression", "Batch")
    all_values <- function(x) {
      if(is.null(x)) return(NULL)
      paste0(names(x), ": ", format(x), collapse = "<br />")
    }
    dat2 %>%
      ggvis(~Sample, ~Expression, fill = ~Batch) %>% layer_boxplots() %>%
      layer_points(prop("x", ~Sample, scale = "xcenter"), fill:="black") %>%
      add_tooltip(all_values, "hover") %>%
      add_axis("x", title = paste(input$noSamples, "Sample(s) Per Batch", sep =" "), properties = axis_props(
        title = list(fontSize = 15),
        labels = list(fontSize = 5, angle = 90)
      )) %>%
      add_axis("y", title = "Expression", properties = axis_props(
        title = list(fontSize = 15),
        labels = list(fontSize = 10)
      )) %>%
      add_legend("fill", title = "Batches", properties = legend_props(
        title = list(fontSize = 15),
        labels = list(fontSize = 10)
      )) %>%
      set_options(width = "auto", height = "auto", resizable=TRUE)
  })
  vis_bp %>% bind_shiny("Boxplot")
  output$BPsummary <- renderPrint({
    summary(BP())
  })
  
  output$BPtable <- renderTable({
    BP()
  })
  
  #interactive scatter plot
  vis_cor <- reactive({
    cormat <- cor(lcounts)
    med_cor <- matrixStats::rowMedians(cormat)
    suggested_cutoff <- quantile(med_cor, p=.25) - 1.5 * IQR(med_cor)
    names(med_cor) <- seq(1:ncol(lcounts))
    cor <- melt(med_cor)
    cor$variable <- names(med_cor)
    cor$batch <- as.factor(batch)
    cor$cutoff <- rep(suggested_cutoff, nrow(cor))
    cor %>% ggvis(~variable,~value,fill=~batch) %>% layer_points() %>% 
      add_tooltip(function(cor){paste0("Sample: ", cor$variable, "<br>", "Batch: ",cor$batch)}, "hover") %>%
      add_axis("y", title = "median pairwise correlation", properties=axis_props(labels=list(fontSize = 10), title = list(fontSize = 15))) %>%
      add_axis("x", title = "", properties=axis_props(labels=list(fontSize = 10,angle = 90))) %>%
      scale_numeric("y", domain = c(pmin(min(med_cor), suggested_cutoff), max(med_cor)), nice = FALSE, clamp = TRUE) %>%
      layer_paths(~variable,~cutoff, strokeDash:=2) %>%
      set_options(width = "auto", height = "auto", resizable=TRUE)
  })
  vis_cor %>% bind_shiny("outliers")
  

  #interactive heatmap
  output$heatmap <- renderD3heatmap({
    d3heatmap(
      lcounts,
      colors = "RdBu",
      labCol = make.unique(as.character(batch)),
      dendrogram = if (input$cluster1) "both" else "none"
    ) })
  
  output$correlation <- renderD3heatmap({
    d3heatmap(
      cormat,
      colors = "RdBu",
      labCol = sample,
      labRow = sample,
      dendrogram = if (input$cluster2) "both" else "none"
    ) })
  
  #interactive density plots
  output$densityQQPlots <- renderPlot({
    layout(matrix(c(1,2,3,4), 2, 2, byrow=TRUE))
    tmp <- density(gamma.hat[input$batches,])
    plot(tmp,  type='l', main="Density Plot",lwd=2)
    xx <- seq(min(tmp$x), max(tmp$x), length=100)
    lines(xx,dnorm(xx,gamma.bar[input$batches],sqrt(t2[input$batches])), col=2,lwd=2)
    qqnorm(gamma.hat[input$batches,])	
    qqline(gamma.hat[input$batches,], col=2,lwd=2)
    tmp <- density(delta.hat[input$batches,])
    invgam <- 1/rgamma(ncol(delta.hat),a.prior[input$batches],b.prior[input$batches])
    tmp1 <- density(invgam)
    plot(tmp, main="Density Plot", ylim=c(0,max(tmp$y,tmp1$y)),lwd=2)
    lines(tmp1, col=2,lwd=2)
    qqplot(delta.hat[input$batches,], invgam, xlab="Sample Quantiles", ylab='Theoretical Quantiles')	
    lines(c(0,max(invgam)),c(0,max(invgam)),col=2,lwd=2)	
    title('Q-Q Plot')
  })
  output$kstest <- renderPrint({  
    ks.test(gamma.hat[input$batches,], "pnorm", gamma.bar[input$batches], sqrt(t2[input$batches])) # two-sided, exact
  })
  output$circos <- renderPlot({
    my.plot(data.matrix, batch, input$AggMethod)
  }, width=800, height=800)
})

